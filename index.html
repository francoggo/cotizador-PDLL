<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador – Paseo de las Laderas</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- 3. jsPDF-autoTable (para tablas en PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            @apply bg-white p-5 rounded-lg shadow-md;
        }
        .btn {
            @apply px-4 py-2 rounded-md font-semibold text-white shadow-sm transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700;
        }
        .btn-green {
            @apply bg-green-600 hover:bg-green-700;
        }
        .input-form {
            @apply w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
        }
        /* Estilo para el input de archivo */
        input[type="file"]::file-selector-button {
            @apply btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm cursor-pointer transition-colors duration-150 mr-4;
        }
        .label-form {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .summary-card {
            @apply bg-white p-4 rounded-lg shadow;
        }
        .summary-title {
            @apply text-sm font-medium text-gray-500;
        }
        .summary-value {
            @apply text-2xl font-bold text-gray-900;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="mb-6 pb-4 border-b border-gray-300 flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-3xl font-bold text-gray-800">Cotizador – Paseo de las Laderas</h1>
            <div class="flex gap-3">
                <button id="btn-pdf" class="btn btn-primary" disabled>Exportar PDF (Lote)</button>
            </div>
        </header>

        <!-- Contenido Principal (Grid) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Columna 1: Configuración -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Card: Datos de Cotización -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Datos de la Cotización</h2>
                    <div class="space-y-3">
                        <!-- CAMBIO: Input para cargar logo -->
                        <div>
                            <label for="input-logo" class="label-form">Cargar Logotipo (Opcional)</label>
                            <input type="file" id="input-logo" class="input-form text-sm" accept="image/png, image/jpeg">
                            <img id="logo-preview" class="hidden w-24 h-auto mt-2 rounded border p-1" alt="Logo Preview">
                        </div>
                        <div>
                            <label for="input-asesor" class="label-form">Asesor Inmobiliario</label>
                            <input type="text" id="input-asesor" class="input-form" placeholder="Nombre del asesor">
                        </div>
                        <div>
                            <label for="input-cliente" class="label-form">Nombre del Cliente</label>
                            <input type="text" id="input-cliente" class="input-form" placeholder="Nombre del cliente">
                        </div>
                        <div>
                            <label for="info-fecha" class="label-form">Fecha de Cotización</label>
                            <input type="text" id="info-fecha" class="input-form bg-gray-100" disabled>
                        </div>
                    </div>
                </div>

                <!-- Card: Selección de Lote -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">1. Seleccionar Lote</h2>
                    <label for="select-lote" class="label-form">Lotes Disponibles (1-100)</label>
                    <select id="select-lote" class="input-form">
                        <option value="">Seleccione un lote...</option>
                    </select>
                    <div id="lote-info" class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200 hidden">
                        <h3 class="font-semibold text-lg">Lote <span id="info-nombre"></span></h3>
                        <div class="grid grid-cols-2 gap-2 text-sm mt-2">
                            <span>ID:</span><span id="info-id" class="font-medium"></span>
                            <span>M²:</span><span id="info-m2" class="font-medium"></span>
                            <span>Precio:</span><span id="info-precio" class="font-medium"></span>
                            <span>Estatus:</span><span id="info-estatus" class="font-medium"></span>
                        </div>
                    </div>
                </div>

                <!-- Card: Configuración de Esquema -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">2. Esquema de Pago (F01)</h2>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label for="input-enganche-pct" class="label-form">Enganche (%)</label>
                            <input type="number" id="input-enganche-pct" class="input-form" value="20" min="10" max="100">
                        </div>
                        <div>
                            <label for="input-financiado-pct" class="label-form">Financiado (%)</label>
                            <input type="number" id="input-financiado-pct" class="input-form" value="60" min="0" max="90">
                        </div>
                        <div>
                            <label for="input-contraentrega-pct" class="label-form">Contraentrega (%)</label>
                            <input type="number" id="input-contraentrega-pct" class="input-form" value="20" min="0" max="90">
                        </div>
                    </div>
                </div>

                <!-- Card: Plazo y Tasa -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">3. Plazo y Tasa</h2>
                    <label for="select-plazo" class="label-form">Plazo (Meses)</label>
                    <select id="select-plazo" class="input-form">
                        <option value="12">12 Meses (0% interés)</option>
                        <option value="24">24 Meses (0% interés)</option>
                        <option value="36">36 Meses (5% anual)</option>
                        <option value="48">48 Meses (7% anual)</option>
                        <option value="60">60 Meses (9% anual)</option>
                        <option value="custom">Personalizado</option>
                    </select>
                    <div id="div-custom-plazo" class="hidden mt-3 grid grid-cols-2 gap-3">
                        <div>
                            <label for="input-plazo-custom" class="label-form">Meses</label>
                            <input type="number" id="input-plazo-custom" class="input-form" value="60" min="1">
                        </div>
                        <div>
                            <label for="input-tasa-custom" class="label-form">Tasa Anual (%)</label>
                            <input type="number" id="input-tasa-custom" class="input-form" value="15" min="0">
                        </div>
                    </div>
                </div>

                <!-- Card: Política Comercial -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">4. Política Comercial</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="input-apartado" class="label-form">Apartado (MXN)</label>
                            <input type="number" id="input-apartado" class="input-form" value="5000">
                        </div>
                        <div>
                            <label for="input-descuento-valor" class="label-form">Descuento</label>
                            <div class="flex">
                                <select id="select-descuento-tipo" class="input-form rounded-r-none w-1/3">
                                    <option value="%">%</option>
                                    <option value="$">$</option>
                                </select>
                                <input type="number" id="input-descuento-valor" class="input-form rounded-l-none w-2/3" value="0" min="0">
                            </div>
                        </div>
                        <div>
                            <label for="input-diferir-enganche" class="label-form">Diferir Enganche (Meses)</label>
                            <input type="number" id="input-diferir-enganche" class="input-form" value="0" min="0">
                            <small class="text-xs text-gray-500">0 = 1 solo pago</small>
                        </div>
                        <div>
                            <label for="input-inicio-fecha" class="label-form">Fecha Inicio Mensualidades</label>
                            <input type="date" id="input-inicio-fecha" class="input-form">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Columna 2: Resultados -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Card: Resumen -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Resumen de Cotización</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="summary-card">
                            <div class="summary-title">Precio Base (c/desc)</div>
                            <div id="res-precio-final" class="summary-value">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">Enganche Total</div>
                            <div id="res-enganche-total" class="summary-value">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">Financiado (Base)</div>
                            <div id="res-financiado-base" class="summary-value">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">Contraentrega</div>
                            <div id="res-contraentrega" class="summary-value">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">Apartado</div>
                            <div id="res-apartado" class="summary-value">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">Mensualidad</div>
                            <div id="res-mensualidad" class="summary-value">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-title">Plazo / Tasa</div>
                            <div id="res-plazo-tasa" class="summary-value">-</div>
                        </div>
                        <div class="summary-card bg-blue-50">
                            <div class="summary-title">Costo Financiero</div>
                            <div id="res-costo-financiero" class="summary-value text-blue-700">-</div>
                        </div>
                    </div>
                </div>

                <!-- Card: Calendario de Pagos -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Calendario de Pagos</h2>
                    <div class="overflow-x-auto max-h-96">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Apartado</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Enganche</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Mensualidad</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Contraentrega</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Subtotal</th>
                                    <!-- NUEVA COLUMNA SALDO (UI) -->
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Saldo</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-calendario" class="bg-white divide-y divide-gray-200">
                                <!-- Filas generadas por JS -->
                                <!-- CAMBIO: colspan="7" -->
                                <tr><td colspan="7" class="p-4 text-center text-gray-500">Seleccione un lote y configure el esquema.</td></tr>
                            </tbody>
                            <tfoot class="bg-gray-100 font-bold sticky bottom-0">
                                <tr id="tfoot-calendario">
                                    <!-- Totales generados por JS -->
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Lógica de la Aplicación -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // Estado global
            let inventario = [];
            let loteSeleccionado = null;
            let calendarioPagos = [];
            let globalTotals = {};
            let logoImgData = null; // <-- CAMBIO: Variable para guardar el logo
            const { jsPDF } = window.jspdf;

            // --- Colores para PDF ---
            const oliveGreen = [85, 107, 47]; // Verde Olivo Oscuro
            const tableHeaderGray = [230, 230, 230]; // Gris claro para pies de tabla
            const tableHeaderText = [0, 0, 0]; // Negro
            const white = [255, 255, 255]; // Blanco

            // Tasas predefinidas
            const TASAS = {
                '12': 0,
                '24': 0,
                '36': 0.05, 
                '48': 0.07, 
                '60': 0.09, 
            };

            // Referencias a elementos DOM
            const selectLote = document.getElementById('select-lote');
            const loteInfo = document.getElementById('lote-info');
            const infoId = document.getElementById('info-id');
            const infoNombre = document.getElementById('info-nombre');
            const infoM2 = document.getElementById('info-m2');
            const infoPrecio = document.getElementById('info-precio');
            const infoEstatus = document.getElementById('info-estatus');

            const inputLogo = document.getElementById('input-logo'); // <-- CAMBIO: Input de logo
            const logoPreview = document.getElementById('logo-preview'); // <-- CAMBIO: Preview de logo
            const inputAsesor = document.getElementById('input-asesor');
            const inputCliente = document.getElementById('input-cliente');
            const infoFecha = document.getElementById('info-fecha');

            const inputEnganchePct = document.getElementById('input-enganche-pct');
            const inputFinanciadoPct = document.getElementById('input-financiado-pct');
            const inputContraentregaPct = document.getElementById('input-contraentrega-pct');

            const selectPlazo = document.getElementById('select-plazo');
            const divCustomPlazo = document.getElementById('div-custom-plazo');
            const inputPlazoCustom = document.getElementById('input-plazo-custom');
            const inputTasaCustom = document.getElementById('input-tasa-custom');

            const inputApartado = document.getElementById('input-apartado');
            const selectDescuentoTipo = document.getElementById('select-descuento-tipo');
            const inputDescuentoValor = document.getElementById('input-descuento-valor');
            const inputDiferirEnganche = document.getElementById('input-diferir-enganche');
            const inputInicioFecha = document.getElementById('input-inicio-fecha');

            const resPrecioFinal = document.getElementById('res-precio-final');
            const resEngancheTotal = document.getElementById('res-enganche-total');
            const resFinanciadoBase = document.getElementById('res-financiado-base');
            const resContraentrega = document.getElementById('res-contraentrega');
            const resApartado = document.getElementById('res-apartado');
            const resMensualidad = document.getElementById('res-mensualidad');
            const resPlazoTasa = document.getElementById('res-plazo-tasa');
            const resCostoFinanciero = document.getElementById('res-costo-financiero');

            const tbodyCalendario = document.getElementById('tbody-calendario');
            const tfootCalendario = document.getElementById('tfoot-calendario');

            const btnPdf = document.getElementById('btn-pdf');

            // --- Funciones de Utilidad ---

            /**
             * Limpia y convierte un string a número (quita $, MXN, comas)
             */
            function parseNumber(str) {
                if (typeof str === 'number') return str;
                return parseFloat(String(str).replace(/[$,MXN\s]/g, '')) || 0;
            }

            /**
             * Formatea un número como moneda MXN sin decimales
             */
            function formatCurrency(num) {
                return new Intl.NumberFormat('es-MX', {
                    style: 'currency',
                    currency: 'MXN',
                    maximumFractionDigits: 0,
                    minimumFractionDigits: 0
                }).format(num);
            }

            /**
             * Formatea un objeto Date a string dd/mm/yyyy
             */
            const formatDate = (date) => {
                if (!date) return '';
                return date.toLocaleDateString('es-MX', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            };

            /**
             * Parsea una fecha en formato dd/mm/yyyy a un objeto Date
             */
            const parseDateMX = (str) => {
                const parts = str.split('/');
                // new Date(año, mes - 1, dia)
                return new Date(parts[2], parts[1] - 1, parts[0]);
            };


            /**
             * Calcula el pago (mensualidad) para un préstamo
             * @param {number} rate Tasa de interés ANUAL (ej. 0.05 para 5%)
             * @param {number} nper Número total de pagos (meses)
             * @param {number} pv Valor presente (monto financiado)
             */
            function PMT(rate, nper, pv) {
                if (nper === 0) return 0;
                // Si la tasa es 0, es prorrateo simple
                if (rate === 0) {
                    return pv / nper;
                }
                const monthlyRate = rate / 12;
                return (pv * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -nper));
            }

            // --- Lógica de Carga y Demo ---

            /**
             * Carga el inventario demo (100 lotes)
             */
            function initializeLotes() {
                inventario = [];
                const basePrice = 350000;

                for (let i = 1; i <= 100; i++) {
                    inventario.push({
                        id: i,
                        nombre: \`Lote \${i}\`,
                        m2: 127,
                        precio: basePrice,
                        estatus: 'Disponible'
                    });
                }
                updateLoteSelector();
                resetCalculations();
            }

            // --- Actualizadores de UI ---

            /**
             * Actualiza el <select> de lotes
             */
            function updateLoteSelector() {
                selectLote.innerHTML = '<option value="">Seleccione un lote...</option>';

                inventario.forEach(lote => {
                    const option = document.createElement('option');
                    option.value = lote.id;
                    option.textContent = \`\${lote.nombre} - \${formatCurrency(lote.precio)}\`;
                    selectLote.appendChild(option);
                });
            }

            /**
             * Muestra la info del lote seleccionado
             */
            function handleLoteSelection() {
                const loteId = selectLote.value;
                loteSeleccionado = inventario.find(l => l.id == loteId) || null;

                if (loteSeleccionado) {
                    infoId.textContent = loteSeleccionado.id;
                    infoNombre.textContent = loteSeleccionado.nombre;
                    infoM2.textContent = \`\${loteSeleccionado.m2} m²\`;
                    infoPrecio.textContent = formatCurrency(loteSeleccionado.precio);
                    infoEstatus.textContent = loteSeleccionado.estatus;
                    loteInfo.classList.remove('hidden');
                    updateCalculations();
                } else {
                    loteInfo.classList.add('hidden');
                    resetCalculations();
                }
                updateButtons();
            }

            /**
             * Normaliza los porcentajes de pago para que sumen 100
             */
            function normalizePercentages(source) {
                let e = parseNumber(inputEnganchePct.value);
                let f = parseNumber(inputFinanciadoPct.value);
                let c = parseNumber(inputContraentregaPct.value);

                if (source === 'e') {
                    f = 100 - e - c;
                } else if (source === 'c') {
                    f = 100 - e - c;
                } else { // 'f'
                    c = 100 - e - f;
                }

                // Asegurarse que no sean negativos y redondear
                e = Math.max(10, Math.min(100, e));
                c = Math.max(0, Math.min(100 - e, c));
                f = Math.max(0, 100 - e - c);

                // Ajuste final si la suma no da 100 (por redondeos o límites)
                const total = e + f + c;
                if (total !== 100) {
                    f = 100 - e - c;
                }

                inputEnganchePct.value = e.toFixed(1);
                inputFinanciadoPct.value = f.toFixed(1);
                inputContraentregaPct.value = c.toFixed(1);

                updateCalculations();
            }

            /**
             * Habilita/deshabilita botones de exportación
             */
            function updateButtons() {
                btnPdf.disabled = !loteSeleccionado || calendarioPagos.length === 0;
            }

            /**
             * Resetea la UI de cálculos
             */
            function resetCalculations() {
                loteSeleccionado = null;
                calendarioPagos = [];
                globalTotals = {}; 
                loteInfo.classList.add('hidden');

                const fields = [resPrecioFinal, resEngancheTotal, resFinanciadoBase, resContraentrega, resApartado, resMensualidad, resPlazoTasa, resCostoFinanciero];
                fields.forEach(f => f.textContent = '-');

                // CAMBIO: colspan="7"
                tbodyCalendario.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">Seleccione un lote y configure el esquema.</td></tr>';
                tfootCalendario.innerHTML = '';
                updateButtons();
            }

            // --- Lógica Principal de Cálculo ---

            /**
             * Obtiene los parámetros actuales de financiamiento
             */
            function getFinanceParams() {
                const apartado = parseNumber(inputApartado.value);
                const descuentoTipo = selectDescuentoTipo.value;
                const descuentoValor = parseNumber(inputDescuentoValor.value);

                const pctE = parseNumber(inputEnganchePct.value) / 100;
                const pctF = parseNumber(inputFinanciadoPct.value) / 100;
                const pctC = parseNumber(inputContraentregaPct.value) / 100;

                const diferirEnganche = parseInt(inputDiferirEnganche.value) || 0;
                const inicioFecha = inputInicioFecha.value; // 'YYYY-MM-DD'

                const plazoKey = selectPlazo.value;
                let nper, tasaAnual, plazoLabel;

                if (plazoKey === 'custom') {
                    nper = parseInt(inputPlazoCustom.value) || 1;
                    tasaAnual = (parseNumber(inputTasaCustom.value) || 0) / 100;
                    plazoLabel = \`\${nper}m @ \${tasaAnual * 100}%\`;
                } else {
                    nper = parseInt(plazoKey);
                    tasaAnual = TASAS[plazoKey];
                    plazoLabel = \`\${nper}m @ \${tasaAnual * 100}%\`;
                }

                return { 
                    apartado, descuentoTipo, descuentoValor, 
                    pctE, pctF, pctC, 
                    diferirEnganche, inicioFecha, 
                    nper, tasaAnual, plazoLabel 
                };
            }

            /**
             * Función principal que recalcula todo para un lote
             */
            function updateCalculations() {
                if (!loteSeleccionado) return;

                // 1. Obtener parámetros
                const params = getFinanceParams();
                const precioLista = loteSeleccionado.precio;

                // 2. Calcular precio base
                const descuento = (params.descuentoTipo === '%')
                    ? precioLista * (params.descuentoValor / 100)
                    : params.descuentoValor;
                const precioBase = precioLista - descuento;

                // 3. Calcular montos
                const montoEnganche = precioBase * params.pctE;
                const montoFinanciado = precioBase * params.pctF;
                const montoContraentrega = precioBase * params.pctC;

                // 4. Calcular pagos
                const engancheRestante = montoEnganche - params.apartado;
                const pagoEngancheDiferido = (params.diferirEnganche > 0)
                    ? engancheRestante / params.diferirEnganche
                    : engancheRestante; // Si es 0, se paga en 1 mes

                const mensualidad = PMT(params.tasaAnual, params.nper, montoFinanciado);

                // 5. Generar calendario
                calendarioPagos = [];
                let calendarMap = {}; // Usar mapa para fusionar meses

                // Función auxiliar para agregar al mapa
                const addToCalendar = (date, tipo, monto) => {
                    if (monto === 0) return;

                    const dateKey = formatDate(date); // Usar string 'dd/mm/yyyy' como clave

                    if (!calendarMap[dateKey]) {
                        calendarMap[dateKey] = { 
                            date: date, // Guardar el objeto Date para ordenar
                            apartado: 0, 
                            enganche: 0, 
                            mensualidad: 0, 
                            contraentrega: 0, 
                            subtotal: 0 
                        };
                    }
                    calendarMap[dateKey][tipo] += monto;
                    calendarMap[dateKey].subtotal += monto;
                };

                // Parsear fechas de inicio
                const fechaCotizacion = parseDateMX(infoFecha.value);
                // Usar T12:00:00 para evitar problemas de timezone con UTC
                const fechaInicioMensualidades = new Date(params.inicioFecha + 'T12:00:00');

                // Mes 0: Apartado (en la fecha de cotización)
                addToCalendar(fechaCotizacion, 'apartado', params.apartado);

                // Mes 1..N: Enganche(s)
                // Comienzan el día 1 del mes siguiente a la cotización
                const fechaInicioEnganche = new Date(fechaCotizacion.getFullYear(), fechaCotizacion.getMonth() + 1, 1);
                const numPagosEnganche = params.diferirEnganche || 1;

                for (let i = 0; i < numPagosEnganche; i++) {
                    // Se crea una nueva fecha cada vez para sumar meses correctamente
                    const fechaPagoEnganche = new Date(fechaInicioEnganche.getFullYear(), fechaInicioEnganche.getMonth() + i, 1);
                    addToCalendar(fechaPagoEnganche, 'enganche', pagoEngancheDiferido);
                }

                // Mes "grace"...N: Mensualidades
                for (let i = 0; i < params.nper; i++) {
                    const fechaPagoMensualidad = new Date(
                        fechaInicioMensualidades.getFullYear(), 
                        fechaInicioMensualidades.getMonth() + i, 
                        fechaInicioMensualidades.getDate()
                    );
                    addToCalendar(fechaPagoMensualidad, 'mensualidad', mensualidad);
                }

                // Mes final: Contraentrega
                // Se paga 1 mes después del último movimiento registrado
                let maxDate = new Date(0);
                Object.values(calendarMap).forEach(p => {
                    if (p.date > maxDate) maxDate = p.date;
                });

                const fechaContraentrega = new Date(maxDate.getFullYear(), maxDate.getMonth() + 1, maxDate.getDate());
                addToCalendar(fechaContraentrega, 'contraentrega', montoContraentrega);


                // Convertir mapa a array y ordenar por fecha
                calendarioPagos = Object.values(calendarMap).sort((a, b) => a.date - b.date);

                // 6. Calcular totales y saldos
                let totalPagado = 0;
                let totalApartado = 0;
                let totalEnganche = 0;
                let totalMensualidad = 0;
                let totalContraentrega = 0;
                // NUEVO: Calcular saldo corriente
                let saldoCorriente = precioBase;

                calendarioPagos.forEach(p => {
                    totalPagado += p.subtotal;
                    totalApartado += p.apartado;
                    totalEnganche += p.enganche;
                    totalMensualidad += p.mensualidad;
                    totalContraentrega += p.contraentrega;

                    // NUEVO: Restar y asignar saldo
                    saldoCorriente -= p.subtotal;
                    // Asegurar que el saldo final sea 0 (evitar -0.0001 por decimales)
                    p.saldo = saldoCorriente < 0.01 ? 0 : saldoCorriente; 
                });

                // Guardar totales en variable global
                globalTotals = {
                    apartado: totalApartado,
                    enganche: totalEnganche,
                    mensualidad: totalMensualidad,
                    contraentrega: totalContraentrega,
                    pagado: totalPagado
                };

                const costoFinanciero = totalPagado - precioBase;

                // 7. Actualizar UI Resumen
                resPrecioFinal.textContent = formatCurrency(precioBase);
                resEngancheTotal.textContent = formatCurrency(montoEnganche);
                resFinanciadoBase.textContent = formatCurrency(montoFinanciado);
                resContraentrega.textContent = formatCurrency(montoContraentrega);
                resApartado.textContent = formatCurrency(params.apartado);
                resMensualidad.textContent = formatCurrency(mensualidad);
                resPlazoTasa.textContent = params.plazoLabel;
                resCostoFinanciero.textContent = formatCurrency(costoFinanciero);

                // 8. Actualizar UI Calendario
                updateCalendarioTable(totalApartado, totalEnganche, totalMensualidad, totalContraentrega, totalPagado);

                // 9. Actualizar Botones
                updateButtons();
            }

            /**
             * Pinta la tabla del calendario
             */
            function updateCalendarioTable(totApartado, totEnganche, totMensualidad, totContraentrega, totPagado) {
                tbodyCalendario.innerHTML = '';
                if (calendarioPagos.length === 0) {
                     // CAMBIO: colspan="7"
                     tbodyCalendario.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">No hay pagos para este esquema.</td></tr>';
                     tfootCalendario.innerHTML = '';
                     return;
                }

                calendarioPagos.forEach(pago => {
                    const tr = document.createElement('tr');
                    // CAMBIO: Añadida celda de Saldo
                    tr.innerHTML = \`
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">\${formatDate(pago.date)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-right">\${formatCurrency(pago.apartado)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-right">\${formatCurrency(pago.enganche)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-right">\${formatCurrency(pago.mensualidad)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-right">\${formatCurrency(pago.contraentrega)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-right font-semibold">\${formatCurrency(pago.subtotal)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-right font-bold text-gray-700">\${formatCurrency(pago.saldo)}</td>
                    \`;
                    tbodyCalendario.appendChild(tr);
                });

                // Fila de Totales
                // CAMBIO: Añadida celda de Saldo (vacía)
                tfootCalendario.innerHTML = \`
                    <tr>
                        <td class="px-4 py-2 text-left text-sm font-bold">Total</td>
                        <td class="px-4 py-2 text-right text-sm font-bold">\${formatCurrency(totApartado)}</td>
                        <td class="px-4 py-2 text-right text-sm font-bold">\${formatCurrency(totEnganche)}</td>
                        <td class="px-4 py-2 text-right text-sm font-bold">\${formatCurrency(totMensualidad)}</td>
                        <td class="px-4 py-2 text-right text-sm font-bold">\${formatCurrency(totContraentrega)}</td>
                        <td class="px-4 py-2 text-right text-sm font-bold">\${formatCurrency(totPagado)}</td>
                        <td class="px-4 py-2 text-right text-sm font-bold">-</td>
                    </tr>
                \`;
            }

            // --- Lógica de Exportación ---

            /**
             * Exporta la cotización del lote actual a PDF
             */
            function exportPDF() {
                if (!loteSeleccionado || calendarioPagos.length === 0) return;

                const doc = new jsPDF();
                const params = getFinanceParams();

                const asesor = inputAsesor.value || 'N/A';
                const cliente = inputCliente.value || 'N/A';
                const fecha = infoFecha.value;

                let yPos; // Posición Y inicial

                // --- 1. Encabezado y Título (CON LOGO) ---
                doc.setFont("helvetica", "normal");
                if (logoImgData) {
                    try {
                        // Intentar añadir la imagen al PDF
                        doc.addImage(logoImgData, 'PNG', 14, 15, 25, 25);
                    } catch (e) {
                        console.error("Error al añadir la imagen al PDF:", e);
                    }
                    doc.setFontSize(18);
                    doc.setFont("helvetica", "bold");
                    doc.text("Cotización – Paseo de las Laderas", 105, 30, { align: 'center' });
                    yPos = 50;
                } else {
                    doc.setFontSize(18);
                    doc.setFont("helvetica", "bold");
                    doc.text("Cotización – Paseo de las Laderas", 105, 22, { align: 'center' });
                    yPos = 35;
                }

                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");

                // --- 2. Datos (Izquierda y Derecha) ---
                doc.setFontSize(10);

                // Columna Izquierda: Datos Cliente
                let yPosLeft = yPos;
                doc.setFont("helvetica", "normal");
                doc.text("Fecha:", 14, yPosLeft);
                doc.text(fecha, 45, yPosLeft);
                yPosLeft += 6;
                doc.text("Cliente:", 14, yPosLeft);
                doc.text(cliente, 45, yPosLeft);
                yPosLeft += 6;
                doc.text("Asesor:", 14, yPosLeft);
                doc.text(asesor, 45, yPosLeft);

                // Columna Derecha: Resumen Financiero
                let yPosRight = yPos;
                const apartadoVal = resApartado.textContent;
                const costoTotalVal = resPrecioFinal.textContent;
                const financiadoVal = resFinanciadoBase.textContent;

                doc.setFont("helvetica", "bold");
                doc.text("Apartado:", 140, yPosRight);
                doc.text(apartadoVal, 200, yPosRight, { align: 'right' });
                yPosRight += 6;
                doc.text("Costo Total Lote:", 140, yPosRight);
                doc.text(costoTotalVal, 200, yPosRight, { align: 'right' });
                yPosRight += 6;
                doc.text("Monto a Financiar:", 140, yPosRight);
                doc.text(financiadoVal, 200, yPosRight, { align: 'right' });

                yPos = Math.max(yPosLeft, yPosRight) + 12;

                // --- 3. Tabla: Datos del Lote ---
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("Datos del Lote", 14, yPos);
                yPos += 5;

                doc.autoTable({
                    startY: yPos,
                    head: [['Lote', 'Área M²', 'Precio M²', 'Valor Lote (Precio Lista)']],
                    body: [[
                        loteSeleccionado.nombre,
                        \`\${loteSeleccionado.m2} m²\`,
                        formatCurrency(loteSeleccionado.precio / loteSeleccionado.m2),
                        formatCurrency(loteSeleccionado.precio)
                    ]],
                    theme: 'grid',
                    styles: { 
                        lineColor: [0, 0, 0],
                        lineWidth: 0.1 
                    },
                    headStyles: { 
                        fillColor: oliveGreen, 
                        textColor: white,
                        fontStyle: 'bold'
                    }
                });
                yPos = doc.lastAutoTable.finalY + 10;

                // --- 4. Tabla: Resumen de Financiamiento ---
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("Resumen de Financiamiento", 14, yPos);
                yPos += 5;

                const mensualidadVal = resMensualidad.textContent;
                const financiamientoVal = \`\${params.nper} Meses\`;
                const interesVal = \`\${(params.tasaAnual * 100).toFixed(1)}% Anual\`;

                doc.autoTable({
                    startY: yPos,
                    head: [['Mensualidad (Aprox)', 'Financiamiento', 'Interés Anual']],
                    body: [[mensualidadVal, financiamientoVal, interesVal]],
                    theme: 'grid',
                    styles: { 
                        lineColor: [0, 0, 0],
                        lineWidth: 0.1 
                    },
                    headStyles: { 
                        fillColor: oliveGreen, 
                        textColor: white,
                        fontStyle: 'bold'
                    }
                });
                yPos = doc.lastAutoTable.finalY + 10;

                // --- 5. Tabla: Desglose del Esquema ---
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("Desglose del Esquema", 14, yPos);
                yPos += 5;

                const descuentoVal = (params.descuentoTipo === '%')
                    ? formatCurrency(loteSeleccionado.precio * (params.descuentoValor / 100))
                    : formatCurrency(params.descuentoValor);

                const bodyData = [
                    ['Precio de Lista', formatCurrency(loteSeleccionado.precio)],
                    ['Descuento Aplicado', \`\${descuentoVal} (\${params.descuentoValor}\${params.descuentoTipo})\`],
                    ['Precio Base (c/desc)', resPrecioFinal.textContent],
                    ['1. Apartado', resApartado.textContent],
                    ['2. Enganche', \`\${resEngancheTotal.textContent} (\${(params.pctE * 100).toFixed(1)}%)\`],
                    ['3. Monto Financiado', \`\${resFinanciadoBase.textContent} (\${(params.pctF * 100).toFixed(1)}%)\`],
                    ['4. Contraentrega', \`\${resContraentrega.textContent} (\${(params.pctC * 100).toFixed(1)}%)\`],
                    ['Costo Financiero Total', resCostoFinanciero.textContent],
                    ['Total Pagado (Simulación)', formatCurrency(globalTotals.pagado || 0)]
                ];

                doc.autoTable({
                    startY: yPos,
                    head: [['Concepto', 'Monto']],
                    body: bodyData,
                    theme: 'grid', 
                    styles: { 
                        lineColor: [0, 0, 0],
                        lineWidth: 0.1 
                    },
                    headStyles: { 
                        fillColor: oliveGreen, 
                        textColor: white,
                        fontStyle: 'bold'
                    },
                    didParseCell: (data) => {
                        const boldRows = ['Precio Base (c/desc)', 'Total Pagado (Simulación)', 'Costo Financiero Total'];
                        if (data.row.section === 'body' && boldRows.includes(data.cell.text[0])) {
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                });

                // --- 6. Calendario de Pagos (Página 2) ---
                doc.addPage();
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text("Calendario de Pagos (Presupuesto)", 14, 20);

                const calHead = [['Fecha', 'Apartado', 'Enganche', 'Mensualidad', 'Contraentrega', 'Subtotal', 'Saldo']];
                const calBody = calendarioPagos.map(p => [
                    formatDate(p.date),
                    formatCurrency(p.apartado),
                    formatCurrency(p.enganche),
                    formatCurrency(p.mensualidad),
                    formatCurrency(p.contraentrega),
                    formatCurrency(p.subtotal),
                    formatCurrency(p.saldo)
                ]);
                calBody.push([
                    'Total',
                    formatCurrency(globalTotals.apartado || 0),
                    formatCurrency(globalTotals.enganche || 0),
                    formatCurrency(globalTotals.mensualidad || 0),
                    formatCurrency(globalTotals.contraentrega || 0),
                    formatCurrency(globalTotals.pagado || 0),
                    '-'
                ]);

                doc.autoTable({
                    startY: 28,
                    head: calHead,
                    body: calBody,
                    theme: 'grid', 
                    styles: { 
                        fontSize: 9,
                        lineColor: [0, 0, 0],
                        lineWidth: 0.1
                    },
                    headStyles: { 
                        fillColor: oliveGreen, 
                        textColor: white,
                        fontStyle: 'bold'
                    },
                    didParseCell: (data) => {
                        if (data.row.index === calBody.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = tableHeaderGray;
                            data.cell.styles.textColor = tableHeaderText;
                        }
                    }
                });

                // --- 7. Nota Legal ---
                const notaLegal = "Cotización informativa, sujeta a disponibilidad y cambios sin previo aviso.";
                doc.setFontSize(8);
                doc.setFont("helvetica", "italic");
                doc.text(notaLegal, 14, doc.lastAutoTable.finalY + 15, { maxWidth: 180 });

                // --- 8. Guardar ---
                doc.save(\`Cotizacion_\${loteSeleccionado.nombre.replace(/\s/g, '_')}_\${cliente.replace(/\s/g, '_')}.pdf\`);
            }

            // --- CAMBIO: Event Listener para el Logo ---
            inputLogo.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        logoImgData = e.target.result;
                        logoPreview.src = logoImgData;
                        logoPreview.classList.remove('hidden');
                    };
                    reader.onerror = (e) => {
                        console.error("Error al leer el archivo:", e);
                        logoImgData = null;
                        logoPreview.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    logoImgData = null;
                    logoPreview.classList.add('hidden');
                }
            });


            // --- Event Listeners ---

            selectLote.addEventListener('change', handleLoteSelection);

            const configInputs = [
                inputApartado, selectDescuentoTipo, inputDescuentoValor,
                inputDiferirEnganche, inputInicioFecha,
                selectPlazo, inputPlazoCustom, inputTasaCustom
            ];
            configInputs.forEach(input => input.addEventListener('input', updateCalculations));

            inputEnganchePct.addEventListener('input', () => normalizePercentages('e'));
            inputFinanciadoPct.addEventListener('input', () => normalizePercentages('f'));
            inputContraentregaPct.addEventListener('input', () => normalizePercentages('c'));

            selectPlazo.addEventListener('change', () => {
                const isCustom = selectPlazo.value === 'custom';
                divCustomPlazo.classList.toggle('hidden', !isCustom);
                updateCalculations();
            });

            btnPdf.addEventListener('click', exportPDF);

            // --- Inicialización ---
            const hoy = new Date();
            infoFecha.value = formatDate(hoy); 
            const primerDiaProximoMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 1);
            inputInicioFecha.value = primerDiaProximoMes.toISOString().split('T')[0];
            initializeLotes();
            updateButtons();

        });
    </script>

</body>
</html>